---
categories: 计算机网络
title: Why we use the Linux kernel's TCP stack?
---

*为什么TCP协议栈要放在Linux内核中呢？*

让我们从一个更广泛的问题开始：运行操作系统到底有什么意义？如果计划运行一个应用程序，则必须使用由数百万行代码组成的内核，这似乎是一种负担。

但是实际上，我们大多数人都决定运行某种操作系统，我们这样做有两个原因。

- 首先，操作系统层增加了硬件独立性和易于使用的API。有了这些，我们可以专注于为任何机器编写代码：不仅是我们目前拥有的专用硬件。
- 其次，操作系统增加了一个时间共享层。这使我们可以一次运行多个应用程序。无论是启动第二个HTTP服务器还是只是启动第二个bash会话，在多个进程之间共享资源的能力至关重要。内核对外开放的所有资源都可以在多个进程之间共享！

通过使用通用的操作系统网络堆栈，我们能够运行多个网络应用程序。如果我们将网卡硬件专用于单个应用程序以运行用户空间的网络堆栈，则会丢失这种能力。如果网卡被一个进程所声明并使用，那么我们将不能够在运行服务器的同时运行SSH会话。

这听起来很不可思议，但这正是大多数现成的用户空间网络堆栈技术所面临的问题。用户空间网络堆栈技术的术语是“完全内核旁路”。其想法是绕过内核，直接从用户空间进程使用网络硬件。

在Linux相关的生态环境中，有一些可用的技术，但是并不是所有都是开源的，比如：PF_RING,  Snabbswitch, DPDK, Netmap等等。

所有这些技术都需要将整个网卡移交给一个进程。换句话说：**我们完全有可能编写自己的网络堆栈**，使其专注于我们所需要的特定功能，并针对性能进行优化。但是这会产生很大的成本：您将被限制为每个网卡最多运行一个进程。

但是即使有所有这些不足之处，我也不能忽略内核旁路的好处。许多人确实运行自定义的网络堆栈，原因是以下两个原因之一：延迟和高性能（更低的CPU开销、更高的吞吐率）。

综合来看，我们可以概括为以下两点：

- 如果是小型设备，需求是通用的，那么使用内核协议栈；
- 如果是大型设备/数据中心，需求是固定/特定的，那么使用DPDK等用户态协议栈，结合网络虚拟化技术，会获得最适合的性能。

# 参考文献

- [Why we use the Linux kernel's TCP stack](https://blog.cloudflare.com/why-we-use-the-linux-kernels-tcp-stack/)