---
categories: NS3
title: Socket在NS3中的实现
---

Socket的源代码位于`src/network`目录下，主要由文件`socket.h`和`socket.cc`构成。以NS3命名空间中`Socket`类的形式进行实现。

与原始的BSD的Socket API不同，NS3中的实现是异步的，其中不再包含会导致阻塞的调用。发送和接收操作都是通过NS3中提供的回调机制实现的。另外，NS3中使用了`Packet`类来作为一个字节的缓冲区，其允许将其在API之间进行传送而不是一个数据的指针。

同样，不是所有的POSIX的Socket API是支持的，但尽管如此，NS3中的实现已经尽可能地接近于原始的BSD版本的实现方式，对于熟悉BSD API的人来说，理解NS3中对于Socket的实现并不困难。

更多的细节可以在官网给出的ns-3 tutorial中找到，此不赘述。

# 枚举类型

## SocketErrno/错误号

根据简写猜了一些错误号代表的意思，已经注释到了代码的后面。

```c++
  /**
   * \enum SocketErrno
   * \brief Enumeration of the possible errors returned by a socket.
   */
  enum SocketErrno {
    ERROR_NOTERROR, // not error
    ERROR_ISCONN, // is connected
    ERROR_NOTCONN, // not connected
    ERROR_MSGSIZE, // message size
    ERROR_AGAIN, // again
    ERROR_SHUTDOWN, // shutdown
    ERROR_OPNOTSUPP, // operation not support
    ERROR_AFNOSUPPORT, // address famliy not support
    ERROR_INVAL, // invalid 
    ERROR_BADF, // bad file descriptor
    ERROR_NOROUTETOHOST, // no route to host
    ERROR_NODEV, // no device
    ERROR_ADDRNOTAVAIL, // address not available
    ERROR_ADDRINUSE, // address in use
    SOCKET_ERRNO_LAST // error number last
  };
```

## SocketType/Socket类型

```c++
  /**
   * \enum SocketType
   * \brief Enumeration of the possible socket types.
   */
  enum SocketType {
    NS3_SOCK_STREAM,
    NS3_SOCK_SEQPACKET,
    NS3_SOCK_DGRAM,
    NS3_SOCK_RAW
  };
```

其中：

- NS3_SOCK_STREAM代表流式Socket，也就是TCP。
- NS3_SOCK_SEQPACKET：**The SOCK_SEQPACKET socket type is similar to the SOCK_STREAM type, and is also connection-oriented.** The only difference between these types is that record boundaries are maintained using the SOCK_SEQPACKET type. A record can be sent using one or more output operations and received using one or more input operations, but a single operation never transfers parts of more than one record. Record boundaries are visible to the receiver via the MSG_EOR flag in the received message flags returned by the recvmsg() function. It is protocol-specific whether a maximum record size is imposed.
- NS3_SOCK_DGRAM代表数据报式Socket，也就是UDP。
- NS3_SOCK_RAW也即是原始套接字是一种不同于SOCK_STREAM、SOCK_DGRAM的套接字，它实现于系统核心。然而，原始套接字能做什么呢？首先来说，普通的套接字无法处理ICMP、IGMP等网络报文，而SOCK_RAW可以；其次，SOCK_RAW也可以处理特殊的IPv4报文。总体来说，SOCK_RAW可以处理普通的网络报文之外，还可以处理一些特殊协议报文以及操作IP层及其以上的数据。

## SocketPriority/Socket优先级

The networking code within Linux handles many protocols besides IP, so in order to handle the priority of a packet in a generic way it is translated to a generic "Linux Priority".  The Linux priority of a packet is a number from 0 to 15, high numbers meaning a higher priority packet.  Not all of the 16 priorities are named in the kernel.

```c++
  /**
   * \enum SocketPriority
   * \brief Enumeration of the possible socket priorities.
   *
   * Names and corresponding values are derived from
   * the Linux TC_PRIO_* macros
   */
  enum SocketPriority {
    NS3_PRIO_BESTEFFORT = 0,
    NS3_PRIO_FILLER = 1,
    NS3_PRIO_BULK = 2,
    NS3_PRIO_INTERACTIVE_BULK = 4,
    NS3_PRIO_INTERACTIVE = 6,
    NS3_PRIO_CONTROL = 7
  };
```



# 参考文献

- [c - Unix socket, SOCK_SEQPACKET vs SOCK_DGRAM - Stack Overflow](https://stackoverflow.com/questions/10104082/unix-socket-sock-seqpacket-vs-sock-dgram)
- [UNIX网络编程——原始套接字SOCK_RAW_网络_ctthuangcheng-CSDN博客](https://blog.csdn.net/ctthunagchneg/article/details/9733619)
- [linux-tc-notes.sourceforge.net/tc/doc/priority.txt](http://linux-tc-notes.sourceforge.net/tc/doc/priority.txt)

